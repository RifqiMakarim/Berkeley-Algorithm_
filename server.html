<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body onload="startTime(); updateTimer();">
    <div id="txt"></div>
    <div id="timer"></div>
    <div id="output"></div>
    <script>
        let countDownDate = new Date().getTime() + (5 * 60 * 1000);
        
        function startTime() {
            const today = new Date();
            let h = today.getHours();
            let m = today.getMinutes();
            let s = today.getSeconds();
            m = checkTime(m);
            s = checkTime(s);
            document.getElementById('txt').innerHTML =  h + ":" + m + ":" + s;
            setTimeout(startTime, 1000);
        }

        function updateTimer() {
            // Get today's date and time
            var now = new Date().getTime();
                
            // Find the distance between now and the count down date
            var distance = countDownDate - now;
                
            // Time calculations for days, hours, minutes and seconds
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById("timer").innerHTML =  minutes + ":" + seconds;
            if (distance <= 0) {
                countDownDate = new Date().getTime() + (5 * 60 * 1000);
            }
            setTimeout(updateTimer, 1000);
        }

        function checkTime(i) {
            if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
            return i;
        }
        const ws = new WebSocket("ws://localhost:8080");
        const output = document.getElementById("output");

        ws.onopen = () => {
        output.textContent = "✅ Terhubung ke WebSocket Server...\n";
        output.innerHTML += "<br />"
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === "sync_result") {
                output.innerHTML = "server offset : " + data.offsets[data.offsets.length - 1] + " ms\n";
                output.innerHTML += "<br />"

                for (let i = 0; i < data.offsets.length - 1; i++) {
                output.innerHTML += "client " + data.clientsIP[i] + " offset : " + data.offsets[i] + " ms\n";
                output.innerHTML += "<br />"
                }
            }
            else if(data.type === "sync_progress") {
                for (let i = 0; i < data.clientsIP.length; i++) {
                output.innerHTML += "Client " + (i + 1) + " : " + data.clientsIP[i];
                output.innerHTML += "<br />"
                }
            }
        };

        ws.onerror = (err) => {
            output.textContent += "\n❌ Gagal terhubung ke WebSocket!\n";
        };
    </script>
</body>
</html>